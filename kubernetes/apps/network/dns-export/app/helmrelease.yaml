# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dns-export
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      # CronJob that generates DNS JSON every 15 minutes
      generator:
        type: cronjob
        cronjob:
          schedule: "*/15 * * * *"
          successfulJobsHistory: 1
          failedJobsHistory: 1

        containers:
          app:
            image:
              repository: alpine
              tag: "3.21"

            command:
              - /bin/sh
              - -c
              - |
                # Install kubectl and jq
                apk add --no-cache curl jq
                curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
                chmod +x kubectl
                mv kubectl /usr/local/bin/

                echo "Generating DNS entries JSON..."

                # Query all ingresses and generate JSON
                kubectl get ingress -A -o json | jq -r '
                  [.items[] |
                    .spec.rules[]? |
                    select(.host | test("albatrossflavour\\.com|pdlf\\.net")) |
                    {
                      hostname: .host,
                      ip: "192.168.8.21"
                    }
                  ] | unique_by(.hostname) | sort_by(.hostname)
                ' > /data/dns-entries.json

                echo "Generated $(cat /data/dns-entries.json | jq 'length') DNS entries"
                cat /data/dns-entries.json | jq -r '.[] | "\(.hostname) -> \(.ip)"' | head -10

            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false

            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                memory: 128Mi

      # Nginx webserver to serve the JSON file
      webserver:
        containers:
          app:
            image:
              repository: nginx
              tag: "1.27-alpine"

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /dns-entries.json
                    port: 80
                  initialDelaySeconds: 10
                  periodSeconds: 30
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /dns-entries.json
                    port: 80
                  initialDelaySeconds: 5
                  periodSeconds: 10

            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                memory: 64Mi

    service:
      webserver:
        controller: webserver
        type: NodePort
        ports:
          http:
            port: 80
            nodePort: 30880

    persistence:
      # Shared storage for JSON file
      data:
        type: persistentVolumeClaim
        size: 100Mi
        storageClass: openebs-hostpath
        accessMode: ReadWriteOnce
        globalMounts:
          - path: /data

      # Nginx configuration to serve JSON with CORS
      nginx-config:
        type: configMap
        name: dns-export-nginx-config
        advancedMounts:
          webserver:
            app:
              - path: /etc/nginx/nginx.conf
                subPath: nginx.conf
                readOnly: true

    configMaps:
      nginx-config:
        data:
          nginx.conf: |
            events {
              worker_connections 1024;
            }
            http {
              server {
                listen 80;

                location / {
                  root /data;
                  add_header Access-Control-Allow-Origin *;
                  add_header Content-Type application/json;
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
                }
              }
            }

    serviceAccount:
      create: false
      name: dns-export
