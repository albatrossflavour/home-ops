# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/batch/cronjob_v1.json
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: proxmox-netbox-sync
spec:
  schedule: "0 2 * * *"  # Daily at 2am
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400  # Clean up after 24 hours
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: proxmox-netbox-sync
              image: python:3.11-slim@sha256:2ec5a4a5c3e919570f57675471f081d6299668d909feabd8d4803c6c61af666c
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Installing dependencies..."
                  apt-get update && apt-get install -y git && apt-get clean && rm -rf /var/lib/apt/lists/*

                  echo "Cloning proxmox-netbox-sync repository..."
                  git clone https://github.com/Yunushan/proxmox-netbox-sync.git /app
                  cd /app

                  echo "Installing Python requirements..."
                  pip install --no-cache-dir proxmoxer pynetbox requests

                  echo "Running Proxmox to NetBox sync..."
                  python3 pve_to_netbox.py

                  echo "Sync completed successfully"
              envFrom:
                - configMapRef:
                    name: proxmox-netbox-sync-config
                - secretRef:
                    name: proxmox-netbox-sync-secret
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
