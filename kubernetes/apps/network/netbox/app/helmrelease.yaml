# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app netbox
spec:
  interval: 30m
  chart:
    spec:
      chart: netbox
      version: 7.2.26
      sourceRef:
        kind: HelmRepository
        name: netbox-community
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    replicaCount: 1

    image:
      registry: ghcr.io
      repository: netbox-community/netbox
      tag: v4.4.9

    # Use existing secret for NetBox configuration
    existingSecret: netbox-secret

    superuser:
      name: admin
      email: admin@local
      existingSecret: netbox-secret

    # Allow all hosts (ingress will handle routing)
    allowedHosts:
      - "*"

    # Basic NetBox configuration
    timeZone: America/New_York
    debug: false
    loginRequired: false

    # Enable GraphQL API
    graphQlEnabled: true

    # Persistence configuration
    persistence:
      enabled: true
      existingClaim: netbox
      storageClass: ""
      accessMode: ReadWriteOnce

    # Disable bundled PostgreSQL, use external
    postgresql:
      enabled: false

    externalDatabase:
      host: postgres16-rw.database.svc.cluster.local
      port: 5432
      database: netbox
      username: netbox
      existingSecretName: netbox-secret  # pragma: allowlist secret
      existingSecretKey: DB_PASSWORD  # pragma: allowlist secret

    # Enable bundled Valkey (Redis fork)
    valkey:
      enabled: true
      sentinel:
        enabled: false
      auth:
        enabled: false

    # Worker for background jobs
    worker:
      enabled: true
      replicaCount: 1

    # Housekeeping cronjob
    housekeeping:
      enabled: true
      schedule: "0 0 * * *"

    # Service configuration
    service:
      type: ClusterIP
      port: 80

    # Ingress configuration
    ingress:
      enabled: true
      className: internal
      annotations:
        external-dns.alpha.kubernetes.io/target: internal.${SECRET_DOMAIN}
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Infrastructure
        gethomepage.dev/name: NetBox
        gethomepage.dev/icon: netbox.png
        gethomepage.dev/description: IPAM and DCIM
      hosts:
        - host: &host netbox.${SECRET_DOMAIN}
          paths:
            - /
      tls:
        - secretName: netbox-tls
          hosts:
            - *host

    # Init containers - add database initialization
    initContainers:
      - name: init-db
        image: ghcr.io/home-operations/postgres-init:18@sha256:866f15038ed5185a2b8118821f470bb7ca0df8c4231b8e277446e681ebb1ed84
        envFrom:
          - secretRef:
              name: netbox-secret

    # Resources
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 2Gi
