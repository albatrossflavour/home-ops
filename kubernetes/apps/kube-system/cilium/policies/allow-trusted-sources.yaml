---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/cilium.io/ciliumnetworkpolicy_v2.json
apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-trusted-sources
  annotations:
    policy.cilium.io/description: "SAFETY FIRST: Always allow trusted sources (private networks, Cloudflare)"
spec:
  description: "Allow all traffic from trusted sources - private networks and Cloudflare tunnel"
  endpointSelector: {}
  ingress:
    # ALWAYS allow all private networks (RFC1918)
    - fromCIDR:
        - 192.168.0.0/16      # All 192.168.x.x networks
        - 10.0.0.0/8          # All 10.x.x.x networks
        - 172.16.0.0/12       # All 172.16-31.x.x networks
      toPorts:
        - ports:
            - port: "1"
              endPort: "65535"
              protocol: TCP
            - port: "1"
              endPort: "65535"
              protocol: UDP

    # ALWAYS allow Cloudflare IPs (for tunnel traffic)
    - fromCIDR:
        # Cloudflare IPv4 ranges (updated Dec 2024)
        - 173.245.48.0/20
        - 103.21.244.0/22
        - 103.22.200.0/22
        - 103.31.4.0/22
        - 141.101.64.0/18
        - 108.162.192.0/18
        - 190.93.240.0/20
        - 188.114.96.0/20
        - 197.234.240.0/22
        - 198.41.128.0/17
        - 162.158.0.0/15
        - 104.16.0.0/13
        - 104.24.0.0/14
        - 172.64.0.0/13
        - 131.0.72.0/22
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "8080"
              protocol: TCP
