<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shit of Theseus — A Team Has No Name — Shitbox Rally 2026</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">  <!-- pragma: allowlist secret -->
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        a { color: #e0a040; text-decoration: none; }
        a:hover { text-decoration: underline; color: #f0c060; }

        /* Header */
        header {
            border-bottom: 1px solid #2a1f0e;
            padding: 1.25rem 2rem;
            background: linear-gradient(180deg, #161b22 0%, #12100c 100%);
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }
        .header-logo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px solid #c06000;
            flex-shrink: 0;
        }
        .header-text { flex: 1; }
        .header-text h1 {
            font-size: 1.5rem;
            color: #f0dbb8;
            font-weight: 700;
        }
        .header-text .team-name {
            color: #e0a040;
            font-size: 0.95rem;
            font-weight: 500;
            font-style: italic;
        }
        .header-text .subtitle {
            color: #8b949e;
            font-size: 0.8rem;
            margin-top: 0.15rem;
        }
        .donate-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            background: #c06000;
            color: #fff !important;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 8px;
            text-decoration: none !important;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .donate-btn:hover { background: #e07010; transform: translateY(-1px); }
        .donate-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* Nav */
        nav {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid #2a1f0e;
            background: #161b22;
        }
        nav a {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #c9d1d9;
            transition: background 0.15s;
        }
        nav a:hover { background: #2a1f0e; text-decoration: none; }
        nav a.active { background: #c06000; color: #fff; }

        main { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; }

        .section { display: none; }
        .section.active { display: block; }

        /* Events */
        #loading { text-align: center; padding: 3rem; color: #8b949e; }
        #error { text-align: center; padding: 3rem; color: #f85149; display: none; }

        .date-group { margin-bottom: 2rem; }
        .date-group h2 {
            font-size: 1rem;
            color: #e0a040;
            font-weight: 500;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #2a1f0e;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
        }

        .event-card {
            background: #161b22;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: border-color 0.15s;
            display: flex;
            flex-direction: column;
        }
        .event-card:hover { border-color: #c06000; }
        .event-card.highlighted { border-color: #e0a040; box-shadow: 0 0 12px rgba(192,96,0,0.3); }

        .event-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        .badge-HIGH_G { background: #da3633; color: #fff; }
        .badge-BIG_CORNER { background: #d29922; color: #fff; }
        .badge-HARD_BRAKE { background: #f85149; color: #fff; }
        .badge-ROUGH_ROAD { background: #8957e5; color: #fff; }
        .badge-BUTTON { background: #238636; color: #fff; }
        .badge-BOOT { background: #40a0c0; color: #fff; }
        .badge-default { background: #30363d; color: #c9d1d9; }

        .event-time {
            font-size: 0.8rem;
            color: #8b949e;
        }

        .event-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 0.75rem;
        }
        .event-stats span strong { color: #f0dbb8; }

        .event-media {
            margin-top: auto;
        }
        .event-video {
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            margin-bottom: 0.5rem;
        }
        .event-video video {
            width: 100%;
            display: block;
        }
        .event-actions {
            display: flex;
            gap: 0.5rem;
        }
        .event-actions a {
            flex: 1;
            display: block;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            background: #21262d;
            border-radius: 6px;
            color: #c9d1d9;
            transition: background 0.15s;
        }
        .event-actions a:hover {
            background: #2a1f0e;
            text-decoration: none;
        }

        /* Map */
        #map {
            height: 70vh;
            border-radius: 8px;
            border: 1px solid #2a1f0e;
            margin-top: 1rem;
        }
        #map-loading { text-align: center; padding: 3rem; color: #8b949e; }
        #map-error { text-align: center; padding: 3rem; color: #f85149; display: none; }
        #map-empty { text-align: center; padding: 3rem; color: #8b949e; display: none; }

        .map-popup .popup-type {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .map-popup .popup-detail {
            font-size: 0.8rem;
            color: #555;
            line-height: 1.5;
        }

        /* Dashboard */
        .grafana-container {
            margin-top: 1rem;
        }
        .grafana-container iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            background: #161b22;
        }
        .grafana-link {
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        /* Footer */
        footer {
            border-top: 1px solid #2a1f0e;
            padding: 1.5rem 2rem;
            text-align: center;
            color: #8b949e;
            font-size: 0.8rem;
            background: #0a0d12;
        }
        footer a { color: #e0a040; }

        @media (max-width: 600px) {
            header { flex-wrap: wrap; padding: 1rem; }
            .header-logo { width: 56px; height: 56px; }
            .header-text h1 { font-size: 1.2rem; }
            .donate-btn { width: 100%; justify-content: center; margin-top: 0.5rem; }
            nav, main { padding-left: 1rem; padding-right: 1rem; }
            .events-grid { grid-template-columns: 1fr; }
            #map { height: 50vh; }
        }
    </style>
</head>
<body>
    <header>
        <img src="data:image/png;base64,__LOGO_B64__" alt="Shitbox Rally 2026" class="header-logo">
        <div class="header-text">
            <h1>Shit of Theseus</h1>
            <div class="team-name">"A Team Has No Name"</div>
            <div class="subtitle">Shitbox Rally 2026 — Rally telemetry from the world's most instrumented shitbox</div>
        </div>
        <a href="https://short.albatrossflavour.com/Shitbox" target="_blank" rel="noopener" class="donate-btn">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            Donate
        </a>
    </header>

    <nav>
        <a href="#events" class="active" data-section="events">Events</a>
        <a href="#map" data-section="map">Map</a>
        <a href="#dashboard" data-section="dashboard">Dashboard</a>
    </nav>

    <main>
        <div id="events-section" class="section active">
            <div id="loading">Loading events...</div>
            <div id="error">Failed to load events. No events data available yet.</div>
            <div id="events-list"></div>
        </div>

        <div id="map-section" class="section">
            <div id="map-loading">Loading map data...</div>
            <div id="map-error">Failed to load event data for map.</div>
            <div id="map-empty">No events with location data yet.</div>
            <div id="map"></div>
        </div>

        <div id="dashboard-section" class="section">
            <div class="grafana-container">
                <iframe
                    src="https://grafana.shit-of-theseus.com/d/shitbox-telemetry?orgId=1&kiosk"
                    frameborder="0"
                    allowfullscreen
                ></iframe>
            </div>
            <a class="grafana-link" href="https://grafana.shit-of-theseus.com" target="_blank" rel="noopener">
                Open full Grafana dashboard &rarr;
            </a>
        </div>
    </main>

    <footer>
        <a href="https://www.shitboxrally.com.au" target="_blank" rel="noopener">Shitbox Rally</a>
        raises money for the Cancer Council.
        <a href="https://short.albatrossflavour.com/Shitbox" target="_blank" rel="noopener">Support our team &rarr;</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>  <!-- pragma: allowlist secret -->
    <script>
    (function() {
        var BADGE_COLORS = {
            HIGH_G: '#da3633',
            BIG_CORNER: '#d29922',
            HARD_BRAKE: '#f85149',
            ROUGH_ROAD: '#8957e5',
            BUTTON: '#238636',
            MANUAL_CAPTURE: '#238636',
            BOOT: '#40a0c0'
        };

        var TIMEZONE = 'Australia/Sydney';

        var DISPLAY_NAMES = {
            HIGH_G: 'High G-Force',
            BIG_CORNER: 'Big Corner',
            HARD_BRAKE: 'Hard Brake',
            ROUGH_ROAD: 'Rough Road',
            BUTTON: 'Manual',
            MANUAL_CAPTURE: 'Manual',
            BOOT: 'Startup'
        };

        var eventsData = null;
        var mapInitialised = false;

        // Navigation
        document.querySelectorAll('nav a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var section = this.getAttribute('data-section');
                document.querySelectorAll('nav a').forEach(function(l) { l.classList.remove('active'); });
                document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById(section + '-section').classList.add('active');
                history.replaceState(null, '', '#' + section);

                if (section === 'map' && !mapInitialised && eventsData) {
                    initMap(eventsData);
                }
            });
        });

        // Handle initial hash
        var hash = window.location.hash.replace('#', '');
        if (hash === 'dashboard' || hash === 'map') {
            document.querySelector('nav a[data-section="' + hash + '"]').click();
        }

        // Load events
        fetch('/captures/events.json')
            .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.json();
            })
            .then(function(events) {
                eventsData = events;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('map-loading').style.display = 'none';
                renderEvents(events);

                if (document.getElementById('map-section').classList.contains('active')) {
                    initMap(events);
                }
            })
            .catch(function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('map-loading').style.display = 'none';
                document.getElementById('map-error').style.display = 'block';
            });

        function renderEvents(events) {
            events.sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            var groups = {};
            events.forEach(function(ev) {
                var date = new Date(ev.timestamp).toLocaleDateString('en-CA', {
                    timeZone: TIMEZONE
                });
                if (!groups[date]) groups[date] = [];
                groups[date].push(ev);
            });

            var container = document.getElementById('events-list');
            var dates = Object.keys(groups).sort().reverse();

            dates.forEach(function(date) {
                var group = document.createElement('div');
                group.className = 'date-group';

                var parts = date.split('-');
                var d = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                var heading = document.createElement('h2');
                heading.textContent = d.toLocaleDateString('en-AU', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    timeZone: 'UTC'
                });
                group.appendChild(heading);

                var grid = document.createElement('div');
                grid.className = 'events-grid';

                groups[date].forEach(function(ev) {
                    // Stable ID from timestamp
                    var eventId = ev.timestamp.replace(/[^0-9]/g, '');

                    var card = document.createElement('div');
                    card.className = 'event-card';
                    card.id = 'event-' + eventId;

                    var badgeClass = 'badge-' + ev.type;
                    var ts = new Date(ev.timestamp);
                    var timeStr = ts.toLocaleTimeString('en-AU', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        timeZone: TIMEZONE
                    });

                    var displayName = DISPLAY_NAMES[ev.type] || ev.type;

                    var noStats = {MANUAL_CAPTURE: 1, BOOT: 1};
                    var statsHtml = '';
                    if (!noStats[ev.type]) {
                        if (ev.speed_kmh !== undefined && ev.speed_kmh > 0) {
                            statsHtml += '<span>Speed: <strong>' + Math.round(ev.speed_kmh) + ' km/h</strong></span>';
                        }
                        if (ev.peak_g !== undefined && ev.peak_g > 0) {
                            statsHtml += '<span>Peak: <strong>' + ev.peak_g.toFixed(2) + ' g</strong></span>';
                        }
                    }

                    var videoHtml = '';
                    var videoSrc = ev.video_url || (ev.video_path ? '/captures/' + ev.video_path : null);
                    var actionsHtml = '<div class="event-actions">' +
                        '<a href="#" class="share-btn" data-event-id="' + eventId + '">Share</a>';
                    if (videoSrc) {
                        videoHtml = '<div class="event-video">' +
                            '<video controls preload="metadata" src="' + videoSrc + '#t=0.1">' +
                            '</video></div>';
                        actionsHtml += '<a href="' + videoSrc + '" download>Download</a>';
                    }
                    actionsHtml += '</div>';

                    card.innerHTML =
                        '<div class="event-header">' +
                        '<span class="badge ' + badgeClass + '">' + displayName + '</span>' +
                        '<span class="event-time">' + timeStr + '</span>' +
                        '</div>' +
                        (statsHtml ? '<div class="event-stats">' + statsHtml + '</div>' : '') +
                        '<div class="event-media">' + videoHtml + actionsHtml + '</div>';

                    grid.appendChild(card);
                });

                group.appendChild(grid);
                container.appendChild(group);
            });

            if (dates.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:3rem;color:#8b949e;">No events recorded yet.</p>';
            }

            // Share button handler
            container.addEventListener('click', function(e) {
                var btn = e.target.closest('.share-btn');
                if (!btn) return;
                e.preventDefault();
                var eid = btn.getAttribute('data-event-id');
                var url = window.location.origin + '/?event=' + eid + '#events';
                navigator.clipboard.writeText(url).then(function() {
                    btn.textContent = 'Copied!';
                    setTimeout(function() { btn.textContent = 'Share'; }, 2000);
                });
            });

            // Deep-link: scroll to event if ?event= param present
            var params = new URLSearchParams(window.location.search);
            var targetId = params.get('event');
            if (targetId) {
                var el = document.getElementById('event-' + targetId);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlighted');
                }
            }
        }

        function initMap(events) {
            mapInitialised = true;

            var geoEvents = events.filter(function(ev) {
                return ev.lat !== undefined && ev.lng !== undefined;
            });

            if (geoEvents.length === 0) {
                document.getElementById('map').style.display = 'none';
                document.getElementById('map-empty').style.display = 'block';
                return;
            }

            var map = L.map('map', {
                zoomControl: true
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            var bounds = L.latLngBounds();
            var markers = [];

            geoEvents.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });

            geoEvents.forEach(function(ev) {
                var color = BADGE_COLORS[ev.type] || '#30363d';
                var ts = new Date(ev.timestamp);
                var dateStr = ts.toLocaleDateString('en-AU', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    timeZone: TIMEZONE
                });
                var timeStr = ts.toLocaleTimeString('en-AU', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    timeZone: TIMEZONE
                });

                var popupName = DISPLAY_NAMES[ev.type] || ev.type;
                var popupLines = [
                    '<div class="map-popup">',
                    '<div class="popup-type" style="color:' + color + '">' + popupName + '</div>',
                    '<div class="popup-detail">',
                    dateStr + ' ' + timeStr
                ];
                if (ev.speed_kmh !== undefined && ev.speed_kmh > 0) {
                    popupLines.push('<br>Speed: ' + Math.round(ev.speed_kmh) + ' km/h');
                }
                if (ev.peak_g !== undefined && ev.peak_g > 0) {
                    popupLines.push('<br>Peak: ' + ev.peak_g.toFixed(2) + ' g');
                }
                var popupVideo = ev.video_url || (ev.video_path ? '/captures/' + ev.video_path : null);
                if (popupVideo) {
                    popupLines.push('<br><a href="' + popupVideo + '" target="_blank" style="color:#e0a040">Watch video</a>');
                }
                popupLines.push('</div></div>');

                var marker = L.circleMarker([ev.lat, ev.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.85
                }).bindPopup(popupLines.join(''));

                marker.addTo(map);
                markers.push(marker);
                bounds.extend([ev.lat, ev.lng]);
            });

            map.fitBounds(bounds, { padding: [40, 40] });
        }
    })();
    </script>
</body>
</html>
