<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shit of Theseus â€” Rally Telemetry</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        a { color: #58a6ff; text-decoration: none; }
        a:hover { text-decoration: underline; }

        header {
            border-bottom: 1px solid #21262d;
            padding: 1.5rem 2rem;
        }
        header h1 {
            font-size: 1.5rem;
            color: #f0f6fc;
            font-weight: 600;
        }
        header p {
            color: #8b949e;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        nav {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid #21262d;
            background: #161b22;
        }
        nav a {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #c9d1d9;
            transition: background 0.15s;
        }
        nav a:hover { background: #21262d; text-decoration: none; }
        nav a.active { background: #1f6feb; color: #fff; }

        main { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; }

        .section { display: none; }
        .section.active { display: block; }

        /* Events */
        #loading { text-align: center; padding: 3rem; color: #8b949e; }
        #error { text-align: center; padding: 3rem; color: #f85149; display: none; }

        .date-group { margin-bottom: 2rem; }
        .date-group h2 {
            font-size: 1rem;
            color: #8b949e;
            font-weight: 500;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #21262d;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
        }

        .event-card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .event-card:hover { border-color: #388bfd; }

        .event-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-HIGH_G { background: #da3633; color: #fff; }
        .badge-BIG_CORNER { background: #d29922; color: #fff; }
        .badge-HARD_BRAKE { background: #f85149; color: #fff; }
        .badge-ROUGH_ROAD { background: #8957e5; color: #fff; }
        .badge-BUTTON { background: #238636; color: #fff; }
        .badge-default { background: #30363d; color: #c9d1d9; }

        .event-time {
            font-size: 0.8rem;
            color: #8b949e;
        }

        .event-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 0.75rem;
        }
        .event-stats span strong { color: #c9d1d9; }

        .event-video {
            border-radius: 6px;
            overflow: hidden;
            background: #000;
        }
        .event-video video {
            width: 100%;
            display: block;
        }
        .event-video-link {
            display: block;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.8rem;
            background: #21262d;
            border-radius: 6px;
        }

        /* Dashboard */
        .grafana-container {
            margin-top: 1rem;
        }
        .grafana-container iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #21262d;
            border-radius: 8px;
            background: #161b22;
        }
        .grafana-link {
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        @media (max-width: 600px) {
            header, nav, main { padding-left: 1rem; padding-right: 1rem; }
            .events-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Shit of Theseus</h1>
        <p>Rally telemetry from the world's most instrumented shitbox</p>
    </header>

    <nav>
        <a href="#events" class="active" data-section="events">Events</a>
        <a href="#dashboard" data-section="dashboard">Dashboard</a>
    </nav>

    <main>
        <div id="events-section" class="section active">
            <div id="loading">Loading events...</div>
            <div id="error">Failed to load events. No events data available yet.</div>
            <div id="events-list"></div>
        </div>

        <div id="dashboard-section" class="section">
            <div class="grafana-container">
                <iframe
                    src="https://grafana.shit-of-theseus.com/d/shitbox-telemetry?orgId=1&kiosk"
                    frameborder="0"
                    allowfullscreen
                ></iframe>
            </div>
            <a class="grafana-link" href="https://grafana.shit-of-theseus.com" target="_blank" rel="noopener">
                Open full Grafana dashboard &rarr;
            </a>
        </div>
    </main>

    <script>
    (function() {
        // Navigation
        document.querySelectorAll('nav a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var section = this.getAttribute('data-section');
                document.querySelectorAll('nav a').forEach(function(l) { l.classList.remove('active'); });
                document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById(section + '-section').classList.add('active');
                history.replaceState(null, '', '#' + section);
            });
        });

        // Handle initial hash
        var hash = window.location.hash.replace('#', '');
        if (hash === 'dashboard') {
            document.querySelector('nav a[data-section="dashboard"]').click();
        }

        // Load events
        fetch('/captures/events.json')
            .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.json();
            })
            .then(function(events) {
                document.getElementById('loading').style.display = 'none';
                renderEvents(events);
            })
            .catch(function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            });

        function renderEvents(events) {
            // Sort newest first
            events.sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // Group by date
            var groups = {};
            events.forEach(function(ev) {
                var date = ev.timestamp.split('T')[0];
                if (!groups[date]) groups[date] = [];
                groups[date].push(ev);
            });

            var container = document.getElementById('events-list');
            var dates = Object.keys(groups).sort().reverse();

            dates.forEach(function(date) {
                var group = document.createElement('div');
                group.className = 'date-group';

                var d = new Date(date + 'T00:00:00');
                var heading = document.createElement('h2');
                heading.textContent = d.toLocaleDateString(undefined, {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                group.appendChild(heading);

                var grid = document.createElement('div');
                grid.className = 'events-grid';

                groups[date].forEach(function(ev) {
                    var card = document.createElement('div');
                    card.className = 'event-card';

                    var badgeClass = 'badge-' + ev.type;
                    var ts = new Date(ev.timestamp);
                    var timeStr = ts.toLocaleTimeString(undefined, {
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });

                    var statsHtml = '';
                    if (ev.peak_g !== undefined) {
                        statsHtml += '<span>Peak: <strong>' + ev.peak_g.toFixed(2) + ' g</strong></span>';
                    }
                    if (ev.duration_ms !== undefined) {
                        statsHtml += '<span>Duration: <strong>' + (ev.duration_ms / 1000).toFixed(1) + 's</strong></span>';
                    }

                    var videoHtml = '';
                    if (ev.video_url) {
                        videoHtml = '<div class="event-video">' +
                            '<video controls preload="none" poster="">' +
                            '<source src="' + ev.video_url + '" type="video/mp4">' +
                            '</video></div>';
                    } else if (ev.video_path) {
                        videoHtml = '<a class="event-video-link" href="/captures/' + ev.video_path + '">Download video</a>';
                    }

                    card.innerHTML =
                        '<div class="event-header">' +
                        '<span class="badge ' + badgeClass + '">' + ev.type + '</span>' +
                        '<span class="event-time">' + timeStr + '</span>' +
                        '</div>' +
                        '<div class="event-stats">' + statsHtml + '</div>' +
                        videoHtml;

                    grid.appendChild(card);
                });

                group.appendChild(grid);
                container.appendChild(group);
            });

            if (dates.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:3rem;color:#8b949e;">No events recorded yet.</p>';
            }
        }
    })();
    </script>
</body>
</html>
