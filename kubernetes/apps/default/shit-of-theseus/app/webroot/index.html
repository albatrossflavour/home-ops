<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shit of Theseus — A Team Has No Name — Shitbox Rally 2026</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">  <!-- pragma: allowlist secret -->
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        a { color: #e0a040; text-decoration: none; }
        a:hover { text-decoration: underline; color: #f0c060; }

        /* Header */
        header {
            border-bottom: 1px solid #2a1f0e;
            padding: 1.25rem 2rem;
            background: linear-gradient(180deg, #161b22 0%, #12100c 100%);
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }
        .header-logo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px solid #c06000;
            flex-shrink: 0;
        }
        .header-text { flex: 1; }
        .header-text h1 {
            font-size: 1.5rem;
            color: #f0dbb8;
            font-weight: 700;
        }
        .header-text .team-name {
            color: #e0a040;
            font-size: 0.95rem;
            font-weight: 500;
            font-style: italic;
        }
        .header-text .subtitle {
            color: #8b949e;
            font-size: 0.8rem;
            margin-top: 0.15rem;
        }
        .donate-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            background: #c06000;
            color: #fff !important;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 8px;
            text-decoration: none !important;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .donate-btn:hover { background: #e07010; transform: translateY(-1px); }
        .donate-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* Nav */
        nav {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid #2a1f0e;
            background: #161b22;
        }
        nav a {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #c9d1d9;
            transition: background 0.15s;
        }
        nav a:hover { background: #2a1f0e; text-decoration: none; }
        nav a.active { background: #c06000; color: #fff; }

        main { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; }

        .section { display: none; }
        .section.active { display: block; }

        /* Events */
        #loading { text-align: center; padding: 3rem; color: #8b949e; }
        #error { text-align: center; padding: 3rem; color: #f85149; display: none; }

        .date-group { margin-bottom: 2rem; }
        .date-group h2 {
            font-size: 1rem;
            color: #e0a040;
            font-weight: 500;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #2a1f0e;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
        }

        .event-card {
            background: #161b22;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: border-color 0.15s;
            display: flex;
            flex-direction: column;
        }
        .event-card:hover { border-color: #c06000; }
        .event-card.highlighted { border-color: #e0a040; box-shadow: 0 0 12px rgba(192,96,0,0.3); }

        .event-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        .badge-HIGH_G { background: #da3633; color: #fff; }
        .badge-BIG_CORNER { background: #d29922; color: #fff; }
        .badge-HARD_BRAKE { background: #f85149; color: #fff; }
        .badge-ROUGH_ROAD { background: #8957e5; color: #fff; }
        .badge-BUTTON { background: #238636; color: #fff; }
        .badge-BOOT { background: #40a0c0; color: #fff; }
        .badge-default { background: #30363d; color: #c9d1d9; }

        .event-time {
            font-size: 0.8rem;
            color: #8b949e;
        }

        .event-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 0.75rem;
        }
        .event-stats span strong { color: #f0dbb8; }

        .event-media {
            margin-top: auto;
        }
        .event-video {
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            margin-bottom: 0.5rem;
        }
        .event-video video {
            width: 100%;
            display: block;
        }
        .event-actions {
            display: flex;
            gap: 0.5rem;
        }
        .event-actions a {
            flex: 1;
            display: block;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            background: #21262d;
            border-radius: 6px;
            color: #c9d1d9;
            transition: background 0.15s;
        }
        .event-actions a:hover {
            background: #2a1f0e;
            text-decoration: none;
        }

        /* Map */
        #map {
            height: 70vh;
            border-radius: 8px;
            border: 1px solid #2a1f0e;
            margin-top: 1rem;
        }
        #map-loading { text-align: center; padding: 3rem; color: #8b949e; }
        #map-error { text-align: center; padding: 3rem; color: #f85149; display: none; }
        #map-empty { text-align: center; padding: 3rem; color: #8b949e; display: none; }

        .map-popup .popup-type {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .map-popup .popup-detail {
            font-size: 0.8rem;
            color: #555;
            line-height: 1.5;
        }

        /* Dashboard */
        .grafana-container {
            margin-top: 1rem;
        }
        .grafana-container iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            background: #161b22;
        }
        .grafana-link {
            display: inline-block;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        /* About */
        .about-hero {
            text-align: center;
            margin-bottom: 2rem;
        }
        .about-hero img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #c06000;
            margin-bottom: 1rem;
        }
        .about-hero h2 {
            font-size: 1.5rem;
            color: #f0dbb8;
            margin-bottom: 0.25rem;
        }
        .about-hero p {
            color: #8b949e;
            font-size: 0.9rem;
        }
        .about-card {
            background: #161b22;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .about-card h3 {
            color: #e0a040;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }
        .about-card p {
            margin-bottom: 0.75rem;
        }
        .about-card p:last-child {
            margin-bottom: 0;
        }
        .route-map {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #2a1f0e;
            margin-top: 0.75rem;
        }
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .team-member {
            background: #161b22;
            border: 1px solid #2a1f0e;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .team-member .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #2a1f0e;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #c06000;
        }
        .team-member h4 {
            color: #f0dbb8;
            margin-bottom: 0.25rem;
        }
        .team-member .member-role {
            color: #e0a040;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .team-member p {
            font-size: 0.875rem;
            color: #8b949e;
        }

        /* Footer */
        footer {
            border-top: 1px solid #2a1f0e;
            padding: 1.5rem 2rem;
            text-align: center;
            color: #8b949e;
            font-size: 0.8rem;
            background: #0a0d12;
        }
        footer a { color: #e0a040; }

        @media (max-width: 600px) {
            header { flex-wrap: wrap; padding: 1rem; }
            .header-logo { width: 56px; height: 56px; }
            .header-text h1 { font-size: 1.2rem; }
            .donate-btn { width: 100%; justify-content: center; margin-top: 0.5rem; }
            nav, main { padding-left: 1rem; padding-right: 1rem; }
            .events-grid { grid-template-columns: 1fr; }
            #map { height: 50vh; }
        }
    </style>
</head>
<body>
    <header>
        <img src="/logo.png" alt="Shitbox Rally 2026" class="header-logo">
        <div class="header-text">
            <h1>Shit of Theseus</h1>
            <div class="team-name">"A Team Has No Name"</div>
            <div class="subtitle">Shitbox Rally 2026 — Rally telemetry from the world's most instrumented shitbox</div>
        </div>
        <a href="https://short.albatrossflavour.com/Shitbox" target="_blank" rel="noopener" class="donate-btn">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            Donate
        </a>
    </header>

    <nav>
        <a href="#events" class="active" data-section="events">Events</a>
        <a href="#map" data-section="map">Map</a>
        <a href="#dashboard" data-section="dashboard">Dashboard</a>
        <a href="#car" data-section="car">The Car</a>
        <a href="#route" data-section="route">Route</a>
        <a href="#about" data-section="about">About</a>
    </nav>

    <main>
        <div id="events-section" class="section active">
            <div id="loading">Loading events...</div>
            <div id="error">Failed to load events. No events data available yet.</div>
            <div id="events-list"></div>
        </div>

        <div id="map-section" class="section">
            <div id="map-loading">Loading map data...</div>
            <div id="map-error">Failed to load event data for map.</div>
            <div id="map-empty">No events with location data yet.</div>
            <div id="map"></div>
        </div>

        <div id="dashboard-section" class="section">
            <div class="grafana-container">
                <iframe
                    src="https://grafana.shit-of-theseus.com/d/shitbox-telemetry?orgId=1&kiosk"
                    frameborder="0"
                    allowfullscreen
                ></iframe>
            </div>
            <a class="grafana-link" href="https://grafana.shit-of-theseus.com" target="_blank" rel="noopener">
                Open full Grafana dashboard &rarr;
            </a>
        </div>
        <div id="car-section" class="section">
            <div class="about-hero">
                <img src="/logo.png" alt="Shitbox Rally 2026">
                <h2>The Shit of Theseus</h2>
                <p>The world's most instrumented shitbox</p>
            </div>

            <div class="about-card">
                <h3>Why "Shit of Theseus"?</h3>
                <p>The Ship of Theseus is a thought experiment: if you replace every plank of a ship one at a time, is it still the same ship? Our car asks the same question, except instead of planks it's head gaskets, radiator hoses, and suspension bushings.</p>
                <p>By the time we reach Melbourne, there's a real chance that more of the car will be replacement parts than original. At what point does it stop being the car we started with? We don't know. But we're going to find out.</p>
            </div>

            <div class="about-card">
                <h3>The Telemetry</h3>
                <p>Everything you see on this site is captured and uploaded automatically from the car. No manual intervention, no post-processing. The entire system is custom-built, open source, and running on a Raspberry Pi bolted to the dash.</p>
            </div>

            <div class="about-card">
                <h3>The Hardware</h3>
                <p>The brains of the operation is a <strong>Raspberry Pi</strong> running a single Python daemon that orchestrates everything. Connected to it over I2C and USB:</p>
                <p><strong>MPU-6050 IMU</strong> (I2C, 0x68) &mdash; 6-axis accelerometer and gyroscope sampling at 100 Hz. This is the core sensor: it feeds a ring buffer that the event detection state machine watches continuously. Accelerometer range is set to &plusmn;4g, gyroscope to &plusmn;500&deg;/s. When it detects a hard brake, big corner, high G-force event, or sustained rough road, it triggers a capture.</p>
                <p><strong>GPS via gpsd</strong> &mdash; A USB GPS receiver providing 1 Hz position, speed, altitude, and satellite count. Speed readings below 3 km/h are floored to zero to eliminate stationary GPS drift. The system tracks three GPS states: gpsd down, connected but no fix, and full satellite lock.</p>
                <p><strong>BME680 Environment Sensor</strong> (I2C, 0x77) &mdash; Temperature, humidity, barometric pressure, and air quality (VOC gas resistance). Sampled at 1 Hz. Useful for tracking engine bay heat soak and ambient conditions along the route.</p>
                <p><strong>INA219 Power Monitor</strong> (I2C, 0x40) &mdash; Measures bus voltage, current draw, and power consumption of the Pi itself. At 1 Hz, this gives us early warning if the car's electrical system is struggling or if the Pi is pulling too much from the cigarette lighter adapter.</p>
                <p><strong>USB Webcam</strong> (/dev/video0) &mdash; 720p at 30fps dashcam via ffmpeg. Runs a continuous ring buffer of 10-second segments, keeping the last 50 seconds. When an event triggers, it stitches the pre-event buffer with 30 seconds of post-event footage into a single MP4 with a GPS/speed overlay. Audio captured from the webcam mic. A physical button on GPIO 17 triggers manual captures too.</p>
                <p><strong>SSD1306 OLED Display</strong> (I2C, 0x3C) &mdash; A tiny 128&times;64 monochrome screen on the dashboard. Four lines showing GPS fix &amp; speed, peak G-force &amp; event count, sensor health (IMU/ENV/PWR), and network status with CPU temperature. Failed sensors show inverted (white-on-black) so problems are obvious at a glance without needing to SSH in at 110 km/h.</p>
                <p><strong>Piezo Buzzer</strong> (GPIO 17) &mdash; Audible confirmation when an event is detected or a manual capture is triggered.</p>
            </div>

            <div class="about-card">
                <h3>The Software</h3>
                <p>The whole system runs as a single systemd service (<code>shitbox-telemetry</code>) managing three concurrent paths:</p>
                <p><strong>High-rate path (100 Hz):</strong> The IMU feeds samples into a ring buffer. An event detection state machine watches for threshold crossings &mdash; sustained high G, hard braking deceleration, lateral cornering force, or rough road vibration. When triggered, it captures the pre-event IMU data and kicks off video recording.</p>
                <p><strong>Low-rate path (1 Hz):</strong> GPS, environment, and power collectors write to a local SQLite database (WAL mode, thread-safe). This is the offline-first core &mdash; everything goes to disk first, network second.</p>
                <p><strong>Capture path:</strong> GPIO button monitoring and video recording via ffmpeg subprocesses. The video ring buffer runs continuously; events just mark where to cut. Timelapse frames are captured every 60 seconds when the car is moving above 5 km/h.</p>
                <p><strong>Sync:</strong> When the Pi has network connectivity (checked against the Prometheus host over WireGuard), a batch sync service reads from a cursor in SQLite and writes to Prometheus via remote_write with Snappy compression. Video and event data are rsynced to a NAS, which is mounted by this website's nginx container via NFS. The system is designed to work entirely offline and catch up when it finds signal.</p>
            </div>

        </div>

        <div id="route-section" class="section">
            <div class="about-card">
                <h3>The Route</h3>
                <p>Port Douglas to Melbourne, May 1st &ndash; 9th 2026. Seven overnight stops across 4,000+ km of outback and alpine roads.</p>
                <img src="/route.jpg" alt="Shitbox Rally 2026 Route: Port Douglas to Melbourne" class="route-map">
            </div>
        </div>

        <div id="about-section" class="section">
            <div class="team-grid">
                <div class="team-member">
                    <div class="member-avatar">T</div>
                    <h4>Tony</h4>
                    <div class="member-role">Driver / Telemetry</div>
                    <p>TODO: Tony's bio goes here.</p>
                </div>
                <div class="team-member">
                    <div class="member-avatar">S</div>
                    <h4>Steve</h4>
                    <div class="member-role">Co-driver / Mechanic</div>
                    <p>TODO: Steve's bio goes here.</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <a href="https://www.shitboxrally.com.au" target="_blank" rel="noopener">Shitbox Rally</a>
        raises money for the Cancer Council.
        <a href="https://short.albatrossflavour.com/Shitbox" target="_blank" rel="noopener">Support our team &rarr;</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>  <!-- pragma: allowlist secret -->
    <script>
    (function() {
        var BADGE_COLORS = {
            HIGH_G: '#da3633',
            BIG_CORNER: '#d29922',
            HARD_BRAKE: '#f85149',
            ROUGH_ROAD: '#8957e5',
            BUTTON: '#238636',
            MANUAL_CAPTURE: '#238636',
            BOOT: '#40a0c0'
        };

        var TIMEZONE = 'Australia/Sydney';

        var DISPLAY_NAMES = {
            HIGH_G: 'High G-Force',
            BIG_CORNER: 'Big Corner',
            HARD_BRAKE: 'Hard Brake',
            ROUGH_ROAD: 'Rough Road',
            BUTTON: 'Manual',
            MANUAL_CAPTURE: 'Manual',
            BOOT: 'Startup'
        };

        var eventsData = null;
        var mapInitialised = false;

        // Navigation
        document.querySelectorAll('nav a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var section = this.getAttribute('data-section');
                document.querySelectorAll('nav a').forEach(function(l) { l.classList.remove('active'); });
                document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById(section + '-section').classList.add('active');
                history.replaceState(null, '', '#' + section);

                if (section === 'map' && !mapInitialised && eventsData) {
                    initMap(eventsData);
                }
            });
        });

        // Handle initial hash
        var hash = window.location.hash.replace('#', '');
        if (hash === 'dashboard' || hash === 'map' || hash === 'car' || hash === 'route' || hash === 'about') {
            document.querySelector('nav a[data-section="' + hash + '"]').click();
        }

        // Load events
        fetch('/captures/events.json')
            .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.json();
            })
            .then(function(events) {
                eventsData = events;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('map-loading').style.display = 'none';
                renderEvents(events);

                if (document.getElementById('map-section').classList.contains('active')) {
                    initMap(events);
                }
            })
            .catch(function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('map-loading').style.display = 'none';
                document.getElementById('map-error').style.display = 'block';
            });

        function renderEvents(events) {
            events.sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            var groups = {};
            events.forEach(function(ev) {
                var date = new Date(ev.timestamp).toLocaleDateString('en-CA', {
                    timeZone: TIMEZONE
                });
                if (!groups[date]) groups[date] = [];
                groups[date].push(ev);
            });

            var container = document.getElementById('events-list');
            var dates = Object.keys(groups).sort().reverse();

            dates.forEach(function(date) {
                var group = document.createElement('div');
                group.className = 'date-group';

                var parts = date.split('-');
                var d = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                var heading = document.createElement('h2');
                heading.textContent = d.toLocaleDateString('en-AU', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    timeZone: 'UTC'
                });
                group.appendChild(heading);

                var grid = document.createElement('div');
                grid.className = 'events-grid';

                groups[date].forEach(function(ev) {
                    // Stable ID from timestamp
                    var eventId = ev.timestamp.replace(/[^0-9]/g, '');

                    var card = document.createElement('div');
                    card.className = 'event-card';
                    card.id = 'event-' + eventId;

                    var badgeClass = 'badge-' + ev.type;
                    var ts = new Date(ev.timestamp);
                    var timeStr = ts.toLocaleTimeString('en-AU', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        timeZone: TIMEZONE
                    });

                    var displayName = DISPLAY_NAMES[ev.type] || ev.type;

                    var noStats = {MANUAL_CAPTURE: 1, BOOT: 1};
                    var statsHtml = '';
                    if (!noStats[ev.type]) {
                        if (ev.speed_kmh !== undefined && ev.speed_kmh > 0) {
                            statsHtml += '<span>Speed: <strong>' + Math.round(ev.speed_kmh) + ' km/h</strong></span>';
                        }
                        if (ev.peak_g !== undefined && ev.peak_g > 0) {
                            statsHtml += '<span>Peak: <strong>' + ev.peak_g.toFixed(2) + ' g</strong></span>';
                        }
                    }

                    var videoHtml = '';
                    var videoSrc = ev.video_url || (ev.video_path ? '/captures/' + ev.video_path : null);
                    var actionsHtml = '<div class="event-actions">' +
                        '<a href="#" class="share-btn" data-event-id="' + eventId + '">Share</a>';
                    if (videoSrc) {
                        videoHtml = '<div class="event-video">' +
                            '<video controls preload="metadata" src="' + videoSrc + '#t=0.1">' +
                            '</video></div>';
                        actionsHtml += '<a href="' + videoSrc + '" download>Download</a>';
                    }
                    actionsHtml += '</div>';

                    card.innerHTML =
                        '<div class="event-header">' +
                        '<span class="badge ' + badgeClass + '">' + displayName + '</span>' +
                        '<span class="event-time">' + timeStr + '</span>' +
                        '</div>' +
                        (statsHtml ? '<div class="event-stats">' + statsHtml + '</div>' : '') +
                        '<div class="event-media">' + videoHtml + actionsHtml + '</div>';

                    grid.appendChild(card);
                });

                group.appendChild(grid);
                container.appendChild(group);
            });

            if (dates.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:3rem;color:#8b949e;">No events recorded yet.</p>';
            }

            // Share button handler
            container.addEventListener('click', function(e) {
                var btn = e.target.closest('.share-btn');
                if (!btn) return;
                e.preventDefault();
                var eid = btn.getAttribute('data-event-id');
                var url = window.location.origin + '/?event=' + eid + '#events';
                navigator.clipboard.writeText(url).then(function() {
                    btn.textContent = 'Copied!';
                    setTimeout(function() { btn.textContent = 'Share'; }, 2000);
                });
            });

            // Deep-link: scroll to event if ?event= param present
            var params = new URLSearchParams(window.location.search);
            var targetId = params.get('event');
            if (targetId) {
                var el = document.getElementById('event-' + targetId);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlighted');
                }
            }
        }

        function initMap(events) {
            mapInitialised = true;

            var geoEvents = events.filter(function(ev) {
                return ev.lat !== undefined && ev.lng !== undefined;
            });

            if (geoEvents.length === 0) {
                document.getElementById('map').style.display = 'none';
                document.getElementById('map-empty').style.display = 'block';
                return;
            }

            var map = L.map('map', {
                zoomControl: true
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            var bounds = L.latLngBounds();
            var markers = [];

            geoEvents.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });

            geoEvents.forEach(function(ev) {
                var color = BADGE_COLORS[ev.type] || '#30363d';
                var ts = new Date(ev.timestamp);
                var dateStr = ts.toLocaleDateString('en-AU', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    timeZone: TIMEZONE
                });
                var timeStr = ts.toLocaleTimeString('en-AU', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    timeZone: TIMEZONE
                });

                var popupName = DISPLAY_NAMES[ev.type] || ev.type;
                var popupLines = [
                    '<div class="map-popup">',
                    '<div class="popup-type" style="color:' + color + '">' + popupName + '</div>',
                    '<div class="popup-detail">',
                    dateStr + ' ' + timeStr
                ];
                if (ev.speed_kmh !== undefined && ev.speed_kmh > 0) {
                    popupLines.push('<br>Speed: ' + Math.round(ev.speed_kmh) + ' km/h');
                }
                if (ev.peak_g !== undefined && ev.peak_g > 0) {
                    popupLines.push('<br>Peak: ' + ev.peak_g.toFixed(2) + ' g');
                }
                var popupVideo = ev.video_url || (ev.video_path ? '/captures/' + ev.video_path : null);
                if (popupVideo) {
                    popupLines.push('<br><a href="' + popupVideo + '" target="_blank" style="color:#e0a040">Watch video</a>');
                }
                popupLines.push('</div></div>');

                var marker = L.circleMarker([ev.lat, ev.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.85
                }).bindPopup(popupLines.join(''));

                marker.addTo(map);
                markers.push(marker);
                bounds.extend([ev.lat, ev.lng]);
            });

            map.fitBounds(bounds, { padding: [40, 40] });
        }
    })();
    </script>
</body>
</html>
