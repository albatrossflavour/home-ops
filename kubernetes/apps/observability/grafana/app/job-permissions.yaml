---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-set-folder-permissions
  namespace: observability
spec:
  # Run every 6 hours to ensure permissions stay correct
  # Also handles new folders created by sidecar dashboards
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 300
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: grafana-permissions-job
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: set-permissions
              image: nicolaka/netshoot:v0.13
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  GRAFANA_URL="http://grafana.observability.svc.cluster.local"
                  VIEWER_ALLOWED_FOLDERS="Puppet"

                  echo "Starting Grafana folder permissions configuration..."
                  echo "Grafana URL: $GRAFANA_URL"

                  # Wait for Grafana to be ready
                  echo "Waiting for Grafana to be ready..."
                  max_attempts=30
                  attempt=0
                  while [ $attempt -lt $max_attempts ]; do
                      if curl -sf "$GRAFANA_URL/api/health" > /dev/null 2>&1; then
                          echo "Grafana is ready!"
                          break
                      fi
                      attempt=$((attempt + 1))
                      echo "Attempt $attempt/$max_attempts: Grafana not ready, waiting..."
                      sleep 10
                  done

                  if [ $attempt -eq $max_attempts ]; then
                      echo "ERROR: Grafana did not become ready in time"
                      exit 1
                  fi

                  # Get all folders
                  echo "Fetching folder list..."
                  folders=$(curl -sf -u "$GRAFANA_ADMIN_USERNAME:$GRAFANA_ADMIN_PASSWORD" "$GRAFANA_URL/api/folders")

                  if [ -z "$folders" ] || [ "$folders" = "[]" ]; then
                      echo "No folders found or unable to fetch folders"
                      exit 0
                  fi

                  echo "Found folders: $folders"

                  # Process each folder
                  echo "$folders" | jq -c '.[]' | while read -r folder; do
                      folder_uid=$(echo "$folder" | jq -r '.uid')
                      folder_title=$(echo "$folder" | jq -r '.title')

                      echo ""
                      echo "Processing folder: $folder_title (UID: $folder_uid)"

                      # Check if this folder should keep Viewer access
                      keep_viewer=false
                      for allowed in $VIEWER_ALLOWED_FOLDERS; do
                          if [ "$folder_title" = "$allowed" ]; then
                              keep_viewer=true
                              break
                          fi
                      done

                      if [ "$keep_viewer" = "true" ]; then
                          echo "  -> Keeping Viewer access for folder: $folder_title"
                          permissions_payload='{"items":[{"role":"Editor","permission":2},{"role":"Viewer","permission":1}]}'
                      else
                          echo "  -> Removing Viewer access for folder: $folder_title"
                          permissions_payload='{"items":[{"role":"Editor","permission":2}]}'
                      fi

                      # Apply permissions
                      if curl -sf -X POST \
                          -u "$GRAFANA_ADMIN_USERNAME:$GRAFANA_ADMIN_PASSWORD" \
                          -H "Content-Type: application/json" \
                          -d "$permissions_payload" \
                          "$GRAFANA_URL/api/folders/$folder_uid/permissions" > /dev/null 2>&1; then
                          echo "  -> Permissions updated successfully"
                      else
                          echo "  WARNING: Failed to set permissions for folder $folder_title"
                      fi
                  done

                  echo ""
                  echo "Folder permissions configuration complete!"
              env:
                - name: GRAFANA_ADMIN_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: grafana-admin-secret
                      key: admin-user
                - name: GRAFANA_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: grafana-admin-secret
                      key: admin-password
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 128Mi
