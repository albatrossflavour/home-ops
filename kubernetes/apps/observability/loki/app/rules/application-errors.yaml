---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-application-rules
  namespace: observability
  labels:
    loki_rule: "true"
  annotations:
    k8s-sidecar-target-directory: "/rules/homelab"
data:
  application-errors.yaml: |
    groups:
      - name: application_errors
        interval: 5m
        rules:
          # High error rate - catches any pod consistently logging errors
          - alert: HighApplicationErrorRate
            expr: |
              sum by (namespace, pod) (
                rate({namespace=~".+"} |~ "(?i)(error|exception|fatal)" [5m])
              ) > 1
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "High error rate in {{ $labels.namespace }}/{{ $labels.pod }}"
              description: "Pod {{ $labels.pod }} is logging {{ $value }} errors/second for 15+ minutes"

          # Redis errors - would have caught NocoDB issue
          - alert: RedisConnectionErrors
            expr: |
              sum by (namespace, pod) (
                rate({namespace=~".+"} |~ "(?i)(READONLY|redis.*error|redis.*connection)" [5m])
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Redis errors in {{ $labels.namespace }}/{{ $labels.pod }}"
              description: "Pod {{ $labels.pod }} is experiencing Redis connection errors"

          # Database connection errors - catches PostgreSQL, MySQL failures
          - alert: DatabaseConnectionErrors
            expr: |
              sum by (namespace, pod) (
                rate({namespace=~".+"} |~ "(?i)(connection.*refused|database.*error|could not connect|connection.*failed)" [5m])
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Database connection errors in {{ $labels.namespace }}/{{ $labels.pod }}"
              description: "Pod {{ $labels.pod }} cannot connect to database"

          # External service failures - would have caught Overseerr Plex issue
          - alert: ExternalServiceConnectionErrors
            expr: |
              sum by (namespace, pod) (
                rate({namespace=~".+"} |~ "(?i)(ECONNREFUSED|connection refused|connect.*failed|timeout)" [5m])
              ) > 0.5
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "External service connection errors in {{ $labels.pod }}"
              description: "Pod {{ $labels.pod }} cannot connect to external services"

          # Authentication failures - security monitoring
          - alert: AuthenticationFailures
            expr: |
              sum by (namespace, pod) (
                rate({namespace=~".+"} |~ "(?i)(authentication.*fail|login.*fail|unauthorized|401|403)" [5m])
              ) > 2
            for: 10m
            labels:
              severity: info
            annotations:
              summary: "High authentication failure rate in {{ $labels.pod }}"
              description: "Pod {{ $labels.pod }} has elevated authentication failures"
