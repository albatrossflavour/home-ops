#!/bin/bash
# gg - Enhanced git commit script with auto-retry for home-ops
# Usage: gg [commit message]

set -euo pipefail

# Check if we're in a git repo
if ! git rev-parse --git-dir &>/dev/null; then
    echo "Not in a git repo"
    exit 1
fi

# Check if we're in home-ops (has .envrc and kubeconfig)
is_home_ops=false
if [[ -f ".envrc" && -f "kubeconfig" ]]; then
    is_home_ops=true
    echo "ğŸš€ Enhanced mode: home-ops repository detected"
fi

# Show git status
git status

# Pause for review
echo
echo "Press Enter to continue with commit (Ctrl+C to cancel)..."
read -r

# Stage all changes
echo "ğŸ“¦ Staging changes..."
git add -A

# Commit logic
if [[ "$is_home_ops" == "true" ]]; then
    # Home-ops: Enhanced with retry
    max_retries=3
    retry_count=0

    echo "ğŸ”„ Starting commit with pre-commit auto-fix retry..."

    while [[ $retry_count -lt $max_retries ]]; do
        echo "ğŸ“ Attempt $((retry_count + 1))/$max_retries"

        if [[ $# -gt 0 ]]; then
            # Use provided commit message
            if git commit -m "$*"; then
                echo "âœ… Commit successful!"
                break
            fi
        else
            # Interactive commit
            if git commit; then
                echo "âœ… Commit successful!"
                break
            fi
        fi

        # Commit failed
        ((retry_count++))
        if [[ $retry_count -lt $max_retries ]]; then
            echo "ğŸ”§ Pre-commit failed, auto-fixing and retrying..."
            echo "   Files may have been automatically corrected"
            git add -A
            sleep 1
        else
            echo "âŒ Max retries reached. Manual intervention needed:"
            echo "   1. Check pre-commit output above"
            echo "   2. Fix remaining issues"
            echo "   3. Run: git add -A && git commit && git push"
            exit 1
        fi
    done
else
    # Other repos: Simple commit
    if [[ $# -gt 0 ]]; then
        git commit -m "$*"
    else
        git commit
    fi
fi

# Push
echo "ğŸš€ Pushing to remote..."
if git push; then
    echo "âœ… Complete! Changes are live."
else
    echo "âŒ Push failed. Try: git pull --rebase && git push"
    exit 1
fi
