---
# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks
fail_fast: false
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: |
          (?x)^(
            bootstrap/|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)
          )
      - id: end-of-file-fixer
        exclude: |
          (?x)^(
            bootstrap/|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)
          )
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-case-conflict
      - id: check-merge-conflict
      - id: check-executables-have-shebangs
      - id: check-symlinks
      - id: check-yaml
        args: [--unsafe]
        exclude: |
          (?x)^(
            bootstrap/|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)
          )
      - id: check-json
      - id: check-toml
      - id: mixed-line-ending
        args: [--fix=lf]
        exclude: |
          (?x)^(
            bootstrap/|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)
          )
      - id: fix-byte-order-marker
      - id: check-vcs-permalinks
      - id: detect-private-key
        exclude: ^(bootstrap/talos/|age\.key)

  # Python specific hooks
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.12.8
    hooks:
      - id: ruff
        args: [--fix]
        exclude: ^bootstrap/
      - id: ruff-format
        exclude: ^bootstrap/

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.17.1
    hooks:
      - id: mypy
        additional_dependencies: [types-requests]
        args: [--ignore-missing-imports, --no-strict-optional]
        exclude: ^(bootstrap/|kubernetes/apps/database/emqx/cluster/resources/)

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        args: [--severity=warning]
        exclude: ^bootstrap/

  # YAML linting and auto-fixing
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args:
          - --config-data
          - |
            extends: default
            rules:
              line-length: disable
              braces: disable
              commas: disable
              comments: disable
              comments-indentation: disable
              document-start: disable
              truthy:
                allowed-values: ['true', 'false', 'on', 'off']
        exclude: |
          (?x)^(
            kubernetes/flux/|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)|
            bootstrap/
          )

  # YAML auto-formatting (optional - can conflict with yamllint)
  # - repo: https://github.com/macisamuele/language-formatters-pre-commit-hooks
  #   rev: v2.14.0
  #   hooks:
  #     - id: pretty-format-yaml
  #       args: [--autofix, --indent, "2"]
  #       exclude: |
  #         (?x)^(
  #           kubernetes/flux/|
  #           kubernetes/apps/.*/(charts?/|helm-charts?/)|
  #           .*/(templates/|crds/)|
  #           bootstrap/
  #         )

  # Kubernetes manifest validation (using local hook)
  # Note: kube-score must be installed separately: brew install kube-score
  # or download from https://github.com/zegl/kube-score/releases

  # Markdown linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.45.0
    hooks:
      - id: markdownlint
        args: [--fix]
        exclude: ^(bootstrap/|kubernetes/)

  # Security scanning for secrets
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: [
          '--baseline', '.secrets.baseline',
          '--exclude-lines', 'secretKey:|remoteRef:|property:|secretKeyRef:|valueFrom:|existingSecret:|secretName:|configSecret:|cluster-user-secrets',
          '--exclude-files', '(.*\.sops\.ya?ml$|.*/externalsecret\.ya?ml$)'
        ]

  # Git commit message linting
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v4.8.3
    hooks:
      - id: commitizen
        stages: [commit-msg]

  # Sort imports
  - repo: https://github.com/pycqa/isort
    rev: 6.0.1
    hooks:
      - id: isort
        args: ["--profile", "black"]
        exclude: ^bootstrap/

  # Validate GitHub Actions
  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.33.2
    hooks:
      - id: check-github-actions
      - id: check-github-workflows

# Local hooks
  - repo: local
    hooks:
      - id: forbidden-files
        name: Forbidden files
        language: fail
        entry: "Found forbidden files"
        files: '(^|/)\.DS_Store$|Thumbs\.db$|\.idea/|\.vscode/workspace\.json$'
      - id: sops-encrypted
        name: Check SOPS encryption
        language: system
        entry: sh -c 'for file in "$@"; do if ! grep -q "^sops:" "$file"; then echo "$file should be encrypted with SOPS"; exit 1; fi; done' --
        files: .*\.sops\.ya?ml$
        exclude: ^\.sops\.ya?ml$
        pass_filenames: true
      - id: kube-score
        name: kube-score
        description: Validate Kubernetes manifests with kube-score
        entry: >-
          bash -c 'if command -v kube-score >/dev/null 2>&1;
          then kube-score score --ignore-test pod-networkpolicy
          --output-format ci "$@";
          else echo "Warning: kube-score not installed, skipping..."; fi'
        language: system
        files: kubernetes/.*\.(yaml|yml)$
        exclude: |
          (?x)^(
            kubernetes/flux/|
            kubernetes/bootstrap/|
            .*\.sops\.yaml|
            kubernetes/apps/.*/(charts?/|helm-charts?/)|
            .*/(templates/|crds/)|
            .*helmrelease\.yaml|
            .*kustomization\.yaml
          )
      - id: container-arch-check
        name: Check container architecture compatibility
        description: Validate containers use SHA256 digests and known good architectures
        entry: >-
          bash -c 'for file in "$@"; do
            if grep -q "image:" "$file"; then
              if grep -E "image:.*[^@]$" "$file" | grep -v "@sha256:"; then
                echo "ERROR: $file contains container images without SHA256 digests"
                echo "Add @sha256:digest to ensure architecture compatibility"
                exit 1
              fi
            fi
          done'
        language: system
        files: kubernetes/.*helmrelease\.ya?ml$
        pass_filenames: true
      - id: volsync-change-validation
        name: Validate Volsync configuration changes
        description: Blocks dangerous Volsync changes (PVC renames, trigger modifications)
        entry: scripts/validate-volsync-change.sh
        language: system
        pass_filenames: false
        stages: [pre-commit]
